---
layout: post
title:  "Koa2å­¦ä¹ ç¬”è®°"
date:   2019-9-10
tags: NodeJs
---

æœ€è¿‘å…¬å¸çš„æŠ€æœ¯åˆ†äº«æ¶‰åŠKoaï¼Œäºæ˜¯é‡æ–°åˆ·äº†ä¸€éï¼Œå­¦ä¹ è¿‡ç¨‹ä¸­ä¸»è¦æ€è€ƒäº†ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

* koaçš„åº”ç”¨åœºæ™¯
* koaçš„ä¼˜åŠ¿
* koaå†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ


### ä¸€ã€Koaçš„åº”ç”¨åœºæ™¯

ä»»ä½•ä¸œè¥¿çš„å‡ºç°éƒ½æœ‰å…¶åˆç†æ€§, Koaæ˜¯ä¸ºäº†æ›´æ–¹ä¾¿æ„å»ºhttpæœåŠ¡è€Œè¯ç”Ÿçš„ä¸€ä¸ªNodeJsæ¡†æ¶ã€‚æ²¡é”™ï¼Œåªä¼šJsçš„ä½ ä¹Ÿå¯ä»¥curläº†ã€‚

### äºŒã€koaçš„ä¼˜åŠ¿

Koaçš„ä¼˜åŠ¿æ€»ç»“ä¸‹æ¥æœ‰ä¸¤ç‚¹: 

* 1.æ›´è½»é‡åŒ–ï¼Œå°è€Œç¾ã€‚
* 2.æ´‹è‘±æ¨¡å‹ï¼Œæ›´å¥½åœ°æ§åˆ¶ä¸­é—´ä»¶æœåŠ¡çš„å¼‚æ­¥é€»è¾‘ã€‚

åœ¨Koaå‡ºç°ä¹‹å‰å…¶å®è¿˜æœ‰Expressæ¡†æ¶ï¼ŒKoaä¹Ÿæ˜¯ExpressåŸç­äººé©¬æ‰“é€ çš„ã€‚Expresså¯ä»¥ç†è§£ä¸ºhttpæœåŠ¡çš„å¤§æ‚çƒ©ï¼Œå„ç§åŠŸèƒ½åº”æœ‰å°½æœ‰ï¼Œå¹¶ä¸”éƒ½æ”¾åœ¨ä¸€èµ·å®ç°ã€‚æ—¢ç„¶æœ‰å‰è€…çš„ç»éªŒé“ºè·¯ï¼ŒKoaçš„å®ç°æ›´åŠ ç²¾ç®€ï¼Œåªè´Ÿè´£æ ¸å¿ƒé€»è¾‘ï¼Œæƒ³è¦ä»€ä¹ˆåŠŸèƒ½ï¼Œåˆ™é€šè¿‡ä¸­é—´ä»¶çš„å½¢å¼å¼•å…¥å°±è¡Œï¼Œå¥½æ¯”å¦‚æ‰“ç«é”…ï¼Œæƒ³åƒä»€ä¹ˆå°±æŠŠä»€ä¹ˆåŠ è¿›å…¥ã€‚

åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿå‚è€ƒäº†å¾ˆå¤šå­¦ä¹ èµ„æ–™ï¼Œå¾ˆå¤šéƒ½æèµ·çœ‹äº†koaçš„æ´‹è‘±æ¨¡å‹ï¼Œé€šç¯‡ä¸‹æ¥è§£é‡Šäº†ä¸€éï¼Œæˆ‘è¿˜æ˜¯æœ‰ä¸å°‘ç–‘æƒ‘ã€‚

æˆ‘ä¸€ç›´åœ¨æƒ³ï¼Œæ´‹è‘±æ¨¡å‹ï¼Œç©¶ç«Ÿé€‚åˆä»€ä¹ˆä¸šåŠ¡åœºæ™¯ï¼Ÿ

asyn awaitè¯­æ³•çš„å‡ºç°åœ¨ä¸€å®šç¨‹åº¦æ¥è¯´ï¼Œæœ‰æ¨è¿›Koa2çš„å‘å±•ï¼Œä½¿å¾—å¼‚æ­¥å¤„ç†é€»è¾‘æ›´åŠ æ¸…æ™°ã€‚ä¸¾ä¸ªğŸŒ°

 ```js

async function log(ctx, next) {
    let requestTime =  new Date().valueOf();
    await next();
    console.log(`${ctx.url} duration: ${new Date().valueOf() - requestTime}`)
}

router.get('/', log, ctx => {
    // do someting
})
 ```

 å› ä¸ºå­˜åœ¨ä¸€äº›è¯­æ³•ç³–ï¼Œé€šè¿‡promiseè¿˜åŸä¸Šè¿°ä»£ç ï¼š

 ```js
 function log() {
     return new Promise((reslove, reject) => {
        let requestTime =  new Date().valueOf();
        next().then(_ => {
            console.log(`${ctx.url} duration: ${new Date().valueOf() - requestTime}`);
        }).then(reslove)
     })
 }
 ```

 ä¹Ÿå°±æ˜¯è¯´ï¼Œè°ƒç”¨nextä¼šç»™æˆ‘ä»¬è¿”å›ä¸€ä¸ªpromiseå¯¹è±¡ï¼Œè€Œpromiseä½•æ—¶ä¼šresolveå°±æ˜¯koaå†…éƒ¨æºç åšçš„å¤„ç†ã€‚

 å†è¯¦ç»†åˆ†æä¸‹koaçš„æ´‹è‘±æ¨¡å‹ä¸Šè¯‰å¤„ç†æµç¨‹ï¼š

1. è·å–å½“å‰æ—¶é—´æˆ³requestTime
2. è°ƒç”¨next()æ‰§è¡Œåç»­çš„ä¸­é—´ä»¶ï¼Œå¹¶ç›‘å¬å›è°ƒ
3. ç¬¬äºŒä¸ªä¸­é—´ä»¶å¯èƒ½ä¼šè°ƒç”¨ç¬¬ä¸‰ä¸ªã€ç¬¬å››ä¸ªã€ç¬¬äº”ä¸ª, ä½†è¿™ä¸æ˜¯logæ‰€å…³å¿ƒçš„ï¼Œlogåªå…³å¿ƒç¬¬äºŒä¸ªä¸­é—´ä»¶ä»€ä¹ˆé€‚åˆresolveï¼Œè€Œç¬¬äºŒä¸ªä¸­é—´ä»¶çš„resolveåˆ™ä¾èµ–ä»–åè¾¹çš„ä¸­é—´ä»¶resolve
4. ç¬¬äºŒä¸ªä¸­é—´ä»¶resolveï¼Œæ„å‘³ç€åé¢çš„ä¸­é—´ä»¶æ‰§è¡Œï¼Œå¹¶ä¸”å…¨éƒ¨resolveäº†ï¼Œæ­¤æ—¶æ‰ä¼šæ‰§è¡Œlogä¸­nextåé¢çš„ä»£ç ã€‚

> æœ¬æ–‡åªæ˜¯ä»¥logä¸ºä¾‹å­ï¼Œç®€å•ä»‹ç»äº†ä¸€ä¸‹koaä¸­é—´ä»¶çš„ä¸€äº›æ ¸å¿ƒæ¦‚å¿µï¼Œåœ¨çœŸæ­£çš„ä¸šåŠ¡åœºæ™¯å½“ç„¶ä¸ä¼šè¿™ä¹ˆç®€å•ã€‚

koaä¸­é—´ä»¶å­˜åœ¨çš„çœŸæ­£æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘åˆé™·å…¥äº†æ€è€ƒï¼Œè°ˆä¸‹æˆ‘ä¸ªäººçš„ç†è§£ã€‚å®¢æˆ·ç«¯å‘é€ä¸€æ¬¡httpè¯·æ±‚ï¼ŒæœåŠ¡ç«¯åœ¨å“åº”æ•°æ®ç»™å®¢æˆ·ç«¯ä¹‹å‰ï¼Œå¯ä»¥é€šè¿‡ä¸­é—´ä»¶çš„ç»„åˆï¼Œè¿›è¡Œæ‹¦æˆªå¤„ç†ã€‚æ¯”å¦‚ï¼Œæ•´åˆè¯·æ±‚å‚æ•°ã€å¯¹è¯·æ±‚çš„urlè¿›è¡Œå·®å¼‚åŒ–å¤„ç†ï¼ŒæŸ¥è¯¢æ•°æ®ç­‰ç­‰ï¼Œå› ä¸ºæœ‰asyn awaitçš„æ”¯æŒï¼Œä¸­é—´ä»¶çš„ç¼–å†™ä»ä»£ç çš„ä¼˜é›…æ€§æ¥è¯´ï¼Œé¿å…äº†then,callbackçš„å†™æ³•ï¼Œæ€»ä½“æ¥è¯´è¿˜æ˜¯æŒºèˆ’æœçš„ï½

### ä¸‰ã€koaå†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ

æ‰“å¼€koaçš„æºç ï¼Œå‘ç°æ ¸å¿ƒcodeéƒ½æ”¾åˆ°äº†libä¸‹ï¼Œåˆ†åˆ«æœ‰å¦‚ä¸‹å‡ ä¸ªæ–‡ä»¶ï¼š

* application.js
* contenxt.js
* request.js
* response.js

koaæŠŠNodeJsåŸç”Ÿè¯·æ±‚ä¸å“åº”é‡æ–°å°è£…äº†ä¸€éï¼Œé€šè¿‡get, setçš„æ–¹å¼è·å–æ•°æ®ä»¥åŠä¿®æ”¹æ•°æ®ï¼Œå¹¶æ•´åˆåˆ°contextä¸­ã€‚

```js
import koa from 'koa'

const app = new koa();

app.use((ctx, next) => {
    ctx.body = 'hello world~';
    next();
})
app.listen(8000, () => {
    // callback
})
```

é€šè¿‡å‡ è¡Œç®€å•çš„ä»£ç å°±å¯ä»¥å¼€å¯ä¸€ä¸ªhttpæœåŠ¡ï¼Œè¯•æƒ³ä¸‹å¦‚æœé€šè¿‡åŸç”Ÿçš„createHttpServe, å¾—èŠ±å¤šå¤§çš„åŠ²ï¼Œæºç ä¸éš¾ç†è§£ï¼Œå¦‚æœä½ å»åˆ·ä¸€éæºç ï¼Œå°±å¯ä»¥æ„Ÿè§‰åˆ°å‰é¢ä¸ºä»€ä¹ˆè¯´koaå°è€Œç¾äº†ã€‚

é˜…è¯»æºç è¿‡åï¼Œæœ‰ä»¥ä¸‹ä¸‰ç‚¹æˆ‘è§‰å¾—æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„ï¼š

1. å®¢æˆ·ç«¯è¯·æ±‚ä¸€æ¬¡ï¼Œkoaå†…éƒ¨éƒ½ä¼šé€šè¿‡const ctx = this.createContext(req, res)é‡æ–°åˆ›å»ºä¸€ä¸ªcontextå¯¹è±¡, æºç å¦‚ä¸‹ï¼š

```js
callback() {
    const fn = compose(this.middleware);

    if (!this.listenerCount('error')) this.on('error', this.onerror);

    const handleRequest = (req, res) => {
      const ctx = this.createContext(req, res);
      return this.handleRequest(ctx, fn);
    };

    return handleRequest;
}

```

----

2. koaå®é™…ä¸Šæ˜¯ç»§æ‰¿NodeJsçš„Emitteräº‹ä»¶çš„ï¼Œä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·åšï¼Ÿ å¾ˆé‡è¦çš„ä¸€ä¸ªåŸå› æ˜¯koaæä¾›è®¢é˜…/å‘å¸ƒåŠŸèƒ½ï¼Œå¦‚æœç¨‹åºå‘ç”Ÿå¼‚å¸¸ï¼Œå°±å¯ä»¥è°ƒç”¨ctx.onerror(err)ï¼Œç›‘å¬äº‹ä»¶é›†ä¸­å¤„ç†å¼‚å¸¸æƒ…å†µï¼Œæºç å¦‚ä¸‹ï¼š

```js
handleRequest(ctx, fnMiddleware) {
    const res = ctx.res;
    res.statusCode = 404;
    const onerror = err => ctx.onerror(err);
    const handleResponse = () => respond(ctx);
    onFinished(res, onerror);
    return fnMiddleware(ctx).then(handleResponse).catch(onerror);
}
```

----

3. ä¸­é—´ä»¶çš„å¤„ç†é€»è¾‘

å¦‚ä¸‹ï¼Œé€šè¿‡useæ–¹æ³•ï¼Œå‡½æ•°ä½œä¸ºuseæ–¹æ³•çš„å‚æ•°ï¼ˆå‡½æ•°çš„å‚æ•°å›ºå®šï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºcontextï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºnextï¼Œè¡¨ç¤ºä¸‹ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°ï¼‰ï¼Œåˆ›å»ºäº†ä¸‰ä¸ªä¸­é—´ä»¶ï¼Œå†…éƒ¨çš„å¤„ç†ä¾æ¬¡è°ƒç”¨this.middleware.push(fn)ï¼Œå°†useçš„å‚æ•°å¡è¿›æ•°ç»„ä¸­ã€‚

```js
app.use((ctx, next) => {
    ctx.body = '1'
    next()
});
app.use((ctx, next) => {
    ctx.body = '2'
    next()
});
app.use((ctx, next) => {
    ctx.body = '3'
    next()
});
```

koaæ´‹è‘±æ¨¡å‹çš„æ ¸å¿ƒä»£ç å°±æ˜¯[koa-compose](https://github.com/koajs/compose)åº“ï¼Œä»£ç åªæœ‰çŸ­çŸ­çš„å‡ åè¡Œï¼Œç‰›é€¼ï½

å®¢æˆ·ç«¯è¿›è¡Œè¯·æ±‚ï¼Œè§¦å‘compose(this.middleware), ä»æºç æˆ‘ä»¬å‘ç°ï¼Œæ­¤æ—¶è‡ªåŠ¨æ‰§è¡Œç¬¬ä¸€ä¸ªä¸­é—´ä»¶ï¼Œä»è€Œé¡ºåºéå†middlewareæ‰€æœ‰å…ƒç´ ï¼Œé€’å½’æ‰§è¡Œdispatchï¼Œæ­¤æ—¶æ´‹è‘±ç”±å¤–åˆ°å†…ï¼Œç›´è‡³æ‰€æœ‰ä¸­é—´ä»¶éƒ½æ‰§è¡Œå®Œæˆåï¼Œresolve, æ´‹è‘±ä»å†…åˆ°å¤–ï¼Œæºç å¦‚ä¸‹ï¼š

```js
function compose (middleware) {
  if (!Array.isArray(middleware)) throw new TypeError('Middleware stack must be an array!')
  for (const fn of middleware) {
    if (typeof fn !== 'function') throw new TypeError('Middleware must be composed of functions!')
  }

  /**
   * @param {Object} context
   * @return {Promise}
   * @api public
   */

  return function (context, next) {
    // last called middleware #
    let index = -1
    return dispatch(0)
    function dispatch (i) {
      if (i <= index) return Promise.reject(new Error('next() called multiple times'))
      index = i
      let fn = middleware[i]
      if (i === middleware.length) fn = next
      if (!fn) return Promise.resolve()
      try {
        return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));
      } catch (err) {
        return Promise.reject(err)
      }
    }
  }
}
```


ä¸Šé¢æˆ‘ä»¬çŸ¥é“ï¼Œä¸­é—´ä»¶çš„æ³¨å†Œæ˜¯é€šè¿‡å¦‚ä¸‹çš„å½¢å¼

```js
app.use((ctx, next) => {
  //do something

  next();
})
```

æ•²é»‘æ¿ï¼Œç•™æ„è¿™è¡Œä»£ç `Promise.resolve(fn(context, dispatch.bind(null, i + 1)))`, å…¶ä¸­dispatch.bind(null, i + 1))å°±æ˜¯next(), koaå†…éƒ¨ä¼šå°†æˆ‘ä»¬æ‰‹åŠ¨æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶ã€‚


### æ„Ÿæ‚Ÿ

æˆ–è®¸æœ‰ä¸€å¤©ä¸“é—¨è·‘å»å†™NodeJsäº†å‘¢?  å“ˆå“ˆ




